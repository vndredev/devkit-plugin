# Auto-generated by devkit-plugin. Do not edit manually.
name: Claude Code Review

on:
  pull_request:
    types: [opened, synchronize, ready_for_review, reopened]

jobs:
  claude-review:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
      issues: read
      id-token: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Run Claude Code Review
        id: claude-review
        uses: anthropics/claude-code-action@v1
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          use_sticky_comment: true
          claude_args: "--model claude-opus-4-5-20251101 --allowedTools 'Bash(gh:*),Bash(git diff:*),Bash(git log:*),Read,Glob,Grep'"
          prompt: |
            Review PR #${{ github.event.pull_request.number }} in ${{ github.repository }}.

            ## Steps
            1. Run `git diff origin/main...HEAD` to see changes
            2. Read .claude/.devkit/config.jsonc for project rules (if exists)
            3. Read modified files for context
            4. Check ALL categories below
            5. Submit official GitHub review (APPROVE or REQUEST_CHANGES)
            6. Update PR body checkboxes (see below)

            ## Update PR Body Checkboxes (REQUIRED)
            After submitting your review, you MUST update the PR body checkboxes.
            Check the boxes that passed your review:

            ```bash
            BODY=$(gh pr view ${{ github.event.pull_request.number }} --json body -q .body)

            # Replace unchecked with checked for passing categories
            # Security: if no security issues found
            BODY=$(echo "$BODY" | sed 's/- \[ \] Security OK/- [x] Security OK/')
            # Bugs: if no bugs found
            BODY=$(echo "$BODY" | sed 's/- \[ \] No Bugs Found/- [x] No Bugs Found/')
            # Code Quality: if acceptable
            BODY=$(echo "$BODY" | sed 's/- \[ \] Code Quality OK/- [x] Code Quality OK/')
            # Architecture: if acceptable
            BODY=$(echo "$BODY" | sed 's/- \[ \] Architecture OK/- [x] Architecture OK/')

            gh pr edit ${{ github.event.pull_request.number }} --body "$BODY"
            ```

            Only check boxes for categories that PASSED. Leave unchecked if issues found.

            ## Checklist

            ### üîê Security (BLOCKING)
            - Command injection, SQL injection, path traversal
            - Secrets in code, unsafe deserialization
            - Missing input validation

            ### üêõ Bugs (BLOCKING)
            - Logic errors, off-by-one, null handling
            - Race conditions, resource leaks, unhandled exceptions

            ### üìù Code Quality
            - Dead code, duplicates, naming, docstrings

            ### üèóÔ∏è Architecture
            - SOLID violations, circular deps, over-engineering

            ### üß™ Testing
            - Missing tests, coverage gaps

            ## OUTPUT FORMAT (follow exactly)

            # Code Review: PR #[number]

            ## Summary
            [1-2 sentences]

            ## üîê Security
            ‚úÖ No issues OR ‚ùå **[Issue]**: description (file:line)

            ## üêõ Bugs
            ‚úÖ No issues OR ‚ùå **[Issue]**: description (file:line)

            ## üìù Code Quality
            ‚úÖ Good OR ‚ö†Ô∏è [suggestion]

            ## üèóÔ∏è Architecture
            ‚úÖ Good OR ‚ö†Ô∏è [suggestion]

            ## üß™ Testing
            ‚úÖ Adequate OR ‚ö†Ô∏è [suggestion]

            ## Verdict
            <!-- VERDICT:APPROVE -->
            üü¢ **APPROVE** - [reason]

            OR

            ## Verdict
            <!-- VERDICT:REQUEST_CHANGES -->
            üî¥ **REQUEST_CHANGES** - [blocking issues]

            ## Rules
            - APPROVE: No Security/Bug issues
            - REQUEST_CHANGES: Any Security/Bug issue

            ## Submitting the Review (REQUIRED)
            After your analysis, you MUST submit an official GitHub review:

            If APPROVE:
            ```bash
            gh pr review ${{ github.event.pull_request.number }} --approve --body "YOUR_REVIEW_CONTENT"
            ```

            If REQUEST_CHANGES:
            ```bash
            gh pr review ${{ github.event.pull_request.number }} --request-changes --body "YOUR_REVIEW_CONTENT"
            ```

            Use the full review content as the body. This submits an official PR review from Claude.
