# Auto-generated by devkit-plugin. Do not edit manually.
name: Claude Code Review

on:
  pull_request:
    types: [opened, synchronize, ready_for_review, reopened]

jobs:
  claude-review:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
      issues: read
      id-token: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Run Claude Code Review
        id: claude-review
        uses: anthropics/claude-code-action@v1
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          use_sticky_comment: true
          claude_args: "--model claude-opus-4-5-20251101 --allowedTools 'Bash(gh:*),Bash(git diff:*),Bash(git log:*),Read,Glob,Grep'"
          prompt: |
            Review PR #${{ github.event.pull_request.number }} in ${{ github.repository }}.

            ## Steps
            1. Run `git diff origin/main...HEAD` to see changes
            2. Read .claude/.devkit/config.jsonc for project rules (if exists)
            3. Read modified files for context
            4. Check ALL categories below
            5. Post review comment: gh pr comment ${{ github.event.pull_request.number }} --body "REVIEW"
            6. Update PR body checkboxes (see below)

            ## Update PR Body Checkboxes (REQUIRED)
            After posting your review comment, you MUST update the PR body checkboxes.
            Check the boxes that passed your review:

            ```bash
            BODY=$(gh pr view ${{ github.event.pull_request.number }} --json body -q .body)

            # Replace unchecked with checked for passing categories
            # Security: if no security issues found
            BODY=$(echo "$BODY" | sed 's/- \[ \] Security OK/- [x] Security OK/')
            # Bugs: if no bugs found
            BODY=$(echo "$BODY" | sed 's/- \[ \] No Bugs Found/- [x] No Bugs Found/')
            # Code Quality: if acceptable
            BODY=$(echo "$BODY" | sed 's/- \[ \] Code Quality OK/- [x] Code Quality OK/')
            # Architecture: if acceptable
            BODY=$(echo "$BODY" | sed 's/- \[ \] Architecture OK/- [x] Architecture OK/')

            gh pr edit ${{ github.event.pull_request.number }} --body "$BODY"
            ```

            Only check boxes for categories that PASSED. Leave unchecked if issues found.

            ## Checklist

            ### ğŸ” Security (BLOCKING)
            - Command injection, SQL injection, path traversal
            - Secrets in code, unsafe deserialization
            - Missing input validation

            ### ğŸ› Bugs (BLOCKING)
            - Logic errors, off-by-one, null handling
            - Race conditions, resource leaks, unhandled exceptions

            ### ğŸ“ Code Quality
            - Dead code, duplicates, naming, docstrings

            ### ğŸ—ï¸ Architecture
            - SOLID violations, circular deps, over-engineering

            ### ğŸ§ª Testing
            - Missing tests, coverage gaps

            ## OUTPUT FORMAT (follow exactly)

            # Code Review: PR #[number]

            ## Summary
            [1-2 sentences]

            ## ğŸ” Security
            âœ… No issues OR âŒ **[Issue]**: description (file:line)

            ## ğŸ› Bugs
            âœ… No issues OR âŒ **[Issue]**: description (file:line)

            ## ğŸ“ Code Quality
            âœ… Good OR âš ï¸ [suggestion]

            ## ğŸ—ï¸ Architecture
            âœ… Good OR âš ï¸ [suggestion]

            ## ğŸ§ª Testing
            âœ… Adequate OR âš ï¸ [suggestion]

            ## Verdict
            <!-- VERDICT:APPROVE -->
            ğŸŸ¢ **APPROVE** - [reason]

            OR

            ## Verdict
            <!-- VERDICT:REQUEST_CHANGES -->
            ğŸ”´ **REQUEST_CHANGES** - [blocking issues]

            ## Rules
            - APPROVE: No Security/Bug issues
            - REQUEST_CHANGES: Any Security/Bug issue
            - The <!-- VERDICT:X --> marker is REQUIRED

      - name: Submit GitHub Review
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          echo "Fetching review comment..."

          REVIEW=$(gh api repos/${{ github.repository }}/issues/${{ github.event.pull_request.number }}/comments \
            --jq '[.[] | select(.user.login | test("claude|github-actions"))] | last | .body' 2>&1) || REVIEW=""

          echo "Review length: ${#REVIEW} chars"

          # Determine verdict and submit official GitHub review
          if echo "$REVIEW" | grep -qF "<!-- VERDICT:APPROVE -->" || echo "$REVIEW" | grep -q "ğŸŸ¢.*APPROVE"; then
            echo ""; echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            echo "ğŸŸ¢ APPROVE - Submitting official review"
            echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            gh pr review ${{ github.event.pull_request.number }} --approve --body "âœ… Claude Code Review: APPROVED"
            exit 0
          fi

          if echo "$REVIEW" | grep -qF "<!-- VERDICT:REQUEST_CHANGES -->" || echo "$REVIEW" | grep -q "ğŸ”´.*REQUEST_CHANGES"; then
            echo ""; echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            echo "ğŸ”´ REQUEST_CHANGES - Submitting official review"
            echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            gh pr review ${{ github.event.pull_request.number }} --request-changes --body "âŒ Claude Code Review: Changes requested - see review comment above"
            exit 1
          fi

          # No verdict - request changes to block
          echo ""; echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "âš ï¸ No verdict found - Requesting changes"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "Review: ${REVIEW:0:300}..."
          gh pr review ${{ github.event.pull_request.number }} --request-changes --body "âš ï¸ Claude Code Review: No verdict found"
          exit 1
