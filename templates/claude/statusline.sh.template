#!/bin/bash
# Claude Code Status Line with devkit integration
# Auto-installed by devkit-plugin
#
# Features:
# - Model and version display
# - Git branch and status (staged/modified/ahead/behind)
# - devkit health check (config/sync/arch)
# - Plugin version with update notification
#
# Error handling: All errors are silently handled to prevent
# statusline failures from breaking Claude Code.

set -o pipefail

# Read JSON input from Claude Code
input=$(cat 2>/dev/null)
if [ -z "$input" ]; then
    echo "Claude"
    exit 0
fi

# Safe jq extraction with defaults
safe_jq() {
    echo "$input" | jq -r "$1" 2>/dev/null || echo "$2"
}

MODEL=$(safe_jq '.model.display_name // "Claude"' "Claude")
VERSION=$(safe_jq '.version // "?"' "?")
CWD=$(safe_jq '.workspace.current_dir // "."' ".")

# Validate CWD exists
if [ ! -d "$CWD" ]; then
    CWD="."
fi

# devkit plugin status - robust detection
DEVKIT_STATUS=""
DEVKIT_MSG=""
DEVKIT_VERSION=""
DEVKIT_DEV_MODE=""
get_devkit_status() {
    # Check if this is a devkit project
    if [ ! -d "$CWD/.claude/.devkit" ]; then
        return
    fi

    # Check for dev mode - working in plugin directory itself
    if [ -f "$CWD/.claude-plugin/plugin.json" ]; then
        local plugin_name
        plugin_name=$(jq -r '.name // ""' "$CWD/.claude-plugin/plugin.json" 2>/dev/null)
        if [ "$plugin_name" = "devkit-plugin" ]; then
            DEVKIT_DEV_MODE="true"
            DEVKIT_VERSION=$(jq -r '.version // "?"' "$CWD/.claude-plugin/plugin.json" 2>/dev/null)
            # Use current directory as plugin root in dev mode
            if [ -f "$CWD/src/arch/check.py" ]; then
                plugin_root="$CWD"
            fi
        fi
    fi

    # Find plugin root - search cache directories dynamically
    local plugin_root="${plugin_root:-}"

    # Priority 1: DEVKIT_PLUGIN_DIR environment variable (for --plugin-dir mode)
    if [ -z "$plugin_root" ] && [ -n "$DEVKIT_PLUGIN_DIR" ] && [ -d "$DEVKIT_PLUGIN_DIR" ]; then
        plugin_root="$DEVKIT_PLUGIN_DIR"
        if [ -f "$plugin_root/.claude-plugin/plugin.json" ]; then
            DEVKIT_VERSION=$(jq -r '.version // "?"' "$plugin_root/.claude-plugin/plugin.json" 2>/dev/null)
        fi
    fi

    # Priority 2: Cache directories
    local cache_base="$HOME/.claude/plugins/cache/claude-marketplace"

    # Try to find devkit-plugin in cache (latest version) - skip if in dev mode
    if [ -z "$plugin_root" ] && [ -d "$cache_base" ]; then
        local plugin_dir="$cache_base/devkit-plugin"
        if [ -d "$plugin_dir" ]; then
            # Find the latest version directory (sort by semver, highest first)
            local latest_version
            latest_version=$(ls -1 "$plugin_dir" 2>/dev/null | sort -V | tail -1)
            if [ -n "$latest_version" ]; then
                local version_dir="$plugin_dir/$latest_version"
                if [ -d "$version_dir" ] && [ -f "$version_dir/src/arch/check.py" ]; then
                    plugin_root="$version_dir"
                    DEVKIT_VERSION="$latest_version"
                fi
            fi
        fi
    fi

    # Fallback to direct plugin path
    if [ -z "$plugin_root" ] && [ -d "$HOME/.claude/plugins/devkit-plugin" ]; then
        plugin_root="$HOME/.claude/plugins/devkit-plugin"
        # Try to get version from plugin.json
        if [ -f "$plugin_root/.claude-plugin/plugin.json" ]; then
            DEVKIT_VERSION=$(jq -r '.version // "?"' "$plugin_root/.claude-plugin/plugin.json" 2>/dev/null)
        fi
    fi

    # Plugin not found
    if [ -z "$plugin_root" ]; then
        DEVKIT_STATUS="error"
        DEVKIT_MSG="plugin missing"
        return
    fi

    # Check for Python environment
    local python_cmd=""
    if [ -f "$plugin_root/.venv/bin/python" ]; then
        python_cmd="$plugin_root/.venv/bin/python"
    elif command -v python3 &>/dev/null; then
        python_cmd="python3"
    else
        DEVKIT_STATUS="error"
        DEVKIT_MSG="python not found"
        return
    fi

    # Run health check with auto-fix for sync issues
    local result
    result=$(cd "$plugin_root" 2>/dev/null && \
        PYTHONPATH=src "$python_cmd" -c "
import os
os.chdir('$CWD')
try:
    from arch.check import check_all
    from lib.config import get
    from lib.sync import sync_all
    from pathlib import Path

    r = check_all()

    # Auto-fix sync issues if enabled
    if not r.get('sync', {}).get('ok'):
        auto_sync = get('hooks.session.auto_sync', True)
        if auto_sync:
            root = Path('$CWD')
            sync_results = sync_all(root=root, check_plugin_update=False)
            synced = sum(1 for _, ok, _ in sync_results if ok)
            if synced > 0:
                # Re-check after sync
                r = check_all()

    if r.get('healthy'):
        print('ok')
    else:
        # Prioritize: show most actionable issue with fix command
        if not r.get('sync', {}).get('ok'):
            print('error:files outdated - run /dk plugin update')
        elif not r.get('config', {}).get('ok'):
            print('error:config invalid - run /dk plugin check')
        elif not r.get('arch', {}).get('ok'):
            print('error:arch violation - run /dk plugin check')
        else:
            print('error:issues found - run /dk plugin check')
except Exception as e:
    print('error:check failed')
" 2>/dev/null)

    if [ "$result" = "ok" ]; then
        DEVKIT_STATUS="ok"
        DEVKIT_MSG="ok"
    elif [[ "$result" == error:* ]]; then
        DEVKIT_STATUS="error"
        DEVKIT_MSG="${result#error:}"
    else
        DEVKIT_STATUS="error"
        DEVKIT_MSG="check failed"
    fi
}

# Git branch detection
GIT_BRANCH=""
get_git_branch() {
    if ! git -C "$CWD" rev-parse --git-dir &>/dev/null; then
        return
    fi

    GIT_BRANCH=$(git -C "$CWD" branch --show-current 2>/dev/null)
}

# Git status (staged/modified/ahead/behind)
GIT_STATUS=""
get_git_status() {
    if [ -z "$GIT_BRANCH" ]; then
        return
    fi

    local staged modified ahead behind
    staged=$(git -C "$CWD" diff --cached --numstat 2>/dev/null | wc -l | tr -d ' ')
    modified=$(git -C "$CWD" diff --numstat 2>/dev/null | wc -l | tr -d ' ')
    ahead=$(git -C "$CWD" rev-list --count '@{upstream}..HEAD' 2>/dev/null || echo "0")
    behind=$(git -C "$CWD" rev-list --count 'HEAD..@{upstream}' 2>/dev/null || echo "0")

    local parts=""
    [ "${staged:-0}" -gt 0 ] && parts+="+${staged} "
    [ "${modified:-0}" -gt 0 ] && parts+="~${modified} "
    [ "${ahead:-0}" -gt 0 ] && parts+="↑${ahead} "
    [ "${behind:-0}" -gt 0 ] && parts+="↓${behind} "

    # Trim trailing space
    parts="${parts% }"
    [ -n "$parts" ] && GIT_STATUS="$parts"
}

# Collect all status info
get_git_branch
get_git_status
get_devkit_status

# Build output with ANSI colors
OUTPUT=""

# Version (gray)
OUTPUT+="\033[90mv$VERSION\033[0m"
OUTPUT+=" \033[90m|\033[0m "

# Model (cyan)
OUTPUT+="\033[36m$MODEL\033[0m"

# Branch (magenta)
if [ -n "$GIT_BRANCH" ]; then
    OUTPUT+=" \033[90m|\033[0m "
    OUTPUT+="\033[35m$GIT_BRANCH\033[0m"

    # Git status (yellow, separate section)
    if [ -n "$GIT_STATUS" ]; then
        OUTPUT+=" \033[33m[$GIT_STATUS]\033[0m"
    fi
fi

# devkit status with version
if [ -n "$DEVKIT_STATUS" ]; then
    OUTPUT+=" \033[90m|\033[0m "

    if [ "$DEVKIT_STATUS" = "ok" ]; then
        # Show version (green) + dev mode indicator
        OUTPUT+="\033[32mdevkit"
        [ -n "$DEVKIT_VERSION" ] && OUTPUT+=" $DEVKIT_VERSION"
        [ -n "$DEVKIT_DEV_MODE" ] && OUTPUT+=" (dev)"
        OUTPUT+="\033[0m"
    else
        # Show error with version if available
        OUTPUT+="\033[1;31mdevkit"
        [ -n "$DEVKIT_VERSION" ] && OUTPUT+=" $DEVKIT_VERSION"
        [ -n "$DEVKIT_DEV_MODE" ] && OUTPUT+=" (dev)"
        OUTPUT+=": $DEVKIT_MSG\033[0m"
    fi
fi

echo -e "$OUTPUT"
