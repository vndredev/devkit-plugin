#!/bin/bash
# Pre-push hook: Block direct pushes to protected branches
# Generated by devkit-plugin - enforces PR-based workflow
#
# Protected branches are configured in .claude/.devkit/config.jsonc
# under git.protected_branches (default: ["main"])

# ANSI colors
RED='\033[0;31m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Get protected branches from config or use default
CONFIG_FILE=".claude/.devkit/config.jsonc"
PROTECTED_BRANCHES="main"

if [ -f "$CONFIG_FILE" ]; then
    # Extract protected_branches array from JSONC (strip comments)
    CONFIGURED=$(grep -v '^\s*//' "$CONFIG_FILE" | grep -o '"protected_branches":\s*\[[^]]*\]' | grep -o '\["[^"]*"\]' | tr -d '[]"' | tr ',' ' ')
    if [ -n "$CONFIGURED" ]; then
        PROTECTED_BRANCHES="$CONFIGURED"
    fi
fi

# Read push info from stdin
while read local_ref local_sha remote_ref remote_sha; do
    # Extract branch name from ref
    if [[ "$remote_ref" =~ refs/heads/(.+) ]]; then
        branch="${BASH_REMATCH[1]}"

        # Check if pushing to protected branch
        for protected in $PROTECTED_BRANCHES; do
            if [ "$branch" = "$protected" ]; then
                echo -e "${RED}ERROR: Direct push to '$branch' is blocked${NC}"
                echo ""
                echo -e "${YELLOW}Protected branches require pull requests.${NC}"
                echo ""
                echo "To create a PR:"
                echo "  1. Create a feature branch: git checkout -b feat/your-feature"
                echo "  2. Push the branch: git push -u origin feat/your-feature"
                echo "  3. Create PR: gh pr create"
                echo ""
                echo "Or use: /dk git pr"
                exit 1
            fi
        done
    fi
done

exit 0
